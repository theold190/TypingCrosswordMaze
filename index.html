<!DOCTYPE html>
<head>
	<script type="text/javascript" src="js/crafty.js"></script>
</head>
<body>
  <script type="text/javascript">
    var DISPLAY_WIDTH = 400,
        DISPLAY_HEIGHT = 400;
    var CELL_WIDTH  = 60,
        CELL_HEIGHT = 60;
    var STEP_WIDTH  = 60,
        STEP_HEIGHT = 60;
    var BOARD_ROWS = 5,
        BOARD_COLS = 5;
    var BOARD_LEFT = 0,
        BOARD_TOP  = 0;
    var BOARD_WIDTH  = BOARD_COLS*STEP_WIDTH,
        BOARD_HEIGHT = BOARD_ROWS*STEP_HEIGHT;
    var CELL_TYPE_LETTER = 0,
        CELL_TYPE_SOLID  = 1,
        CELL_TYPE_FINISH = 2;

    function initCrafty() {
        // Initialize Crafty
        Crafty.init(DISPLAY_WIDTH, DISPLAY_HEIGHT);

        Crafty.c("Game", {
            init: function() {
                this.addComponent("");
            },
            _setPlayer: function(player) {
                this._player = player;
            },
            _setBoard: function(board) {
                this._board = board;
            },
            _playerUpdate: function(x, y) {
                var cell = this._board._getCell(x, y);
                if (cell._type == CELL_TYPE_FINISH) {
                    alert("Congratulations!");
                }
            }
        });

        Crafty.c("Player", {
            init: function() {
                this.addComponent("2D, Canvas, Color, KeyboardEvent");
                this.attr({x: BOARD_LEFT, y: BOARD_TOP, w:CELL_WIDTH, h:CELL_HEIGHT});
                this.color("#FFAA11");

                this.bind('KeyDown', function(e) {
                    if (this._navigatePlayer(e.key)) {
                        if (this._playerUpdateCallback != undefined) {
                            this._playerUpdateCallback(this.x, this.y);
                        }
                    }
                });
            },
            _navigatePlayer: function(key) {
                if (this._canGoLeft()) {
                    var cell = this._board._getCellOnLeft(this.x, this.y);
                    if(cell._isAssignedKey(key)) {
                        this._goLeft();
                        return true;
                    }
                }
                if (this._canGoRight()) {
                    var cell = this._board._getCellOnRight(this.x, this.y);
                    if(cell._isAssignedKey(key)) {
                        this._goRight();
                        return true;
                    }
                }
                if (this._canGoUp()) {
                    var cell = this._board._getCellOnTop(this.x, this.y);
                    if(cell._isAssignedKey(key)) {
                        this._goUp();
                        return true;
                    }
                }
                if (this._canGoDown()) {
                    var cell = this._board._getCellOnBottom(this.x, this.y);
                    if(cell._isAssignedKey(key)) {
                        this._goDown();
                        return true;
                    }
                }

                if(key == Crafty.keys['LEFT_ARROW']) {
                    this._goLeft();
                    return true;
                } else if (key == Crafty.keys['RIGHT_ARROW']) {
                    this._goRight();
                    return true;
                } else if (key == Crafty.keys['UP_ARROW']) {
                    this._goUp();
                    return true;
                } else if (key == Crafty.keys['DOWN_ARROW']) {
                    this._goDown();
                    return true;
                }
                return false;
            },
            _setBoard: function(board) {
                this._board = board;
                return this;
            },
            _setUpdateCallback: function(callback) {
                this._playerUpdateCallback = callback;
            },
            _setStartPosition: function(x, y) {
                this.attr({x: x, y: y});
                return this;
            },
            _canGoUp: function() {
                var cell = this._board._getCellOnTop(this.x, this.y);
                if (cell == undefined || cell._type == CELL_TYPE_SOLID) {
                    return false;
                }
                return true;
            },
            _canGoDown: function() {
                var cell = this._board._getCellOnBottom(this.x, this.y);
                if (cell == undefined || cell._type == CELL_TYPE_SOLID) {
                    return false;
                }
                return true;
            },
            _canGoLeft: function() {
                var cell = this._board._getCellOnLeft(this.x, this.y);
                if (cell == undefined || cell._type == CELL_TYPE_SOLID) {
                    return false;
                }
                return true;
            },
            _canGoRight: function() {
                var cell = this._board._getCellOnRight(this.x, this.y);
                if (cell == undefined || cell._type == CELL_TYPE_SOLID) {
                    return false;
                }
                return true;
            },
            _goUp: function () {
                if(this._canGoUp()) {this.y = this.y - STEP_HEIGHT;}
            },
            _goDown: function () {
                if(this._canGoDown()) {this.y = this.y + STEP_HEIGHT;}
            },
            _goLeft: function () {
                if(this._canGoLeft()) {this.x = this.x - STEP_WIDTH;}
            },
            _goRight: function () {
                if(this._canGoRight()) {this.x = this.x + STEP_WIDTH;}
            }
        });

        Crafty.c("Cell", {
            ready: true,
            init: function() {
                this.addComponent("2D, Canvas, Color, Text");
                this.w = CELL_WIDTH;
                this.h = CELL_HEIGHT;
                this.textColor('#000000', 1);
                this.textFont({size: '50px', family: 'Arial'});
            },
            _type: CELL_TYPE_LETTER,
            _makeCell: function(x, y, type, text) {
                var COLORS = ['#FFF', '#000', "#00F"];
                this.attr({x: x, y: y}).color(COLORS[type]).text(text);
                this._type = type;
                return this;
            },
            _isInsideCell: function(x, y) {
                if (this.x <= x && this.x+this.w > x) {
                    if (this.y <= y && this.y+this.h > y) {
                        return true;
                    }
                }
                return false;
            },
            _isAssignedKey: function(key) {
                if (key == Crafty.keys[this._text]) {
                    return true;
                }
                if (this._type == CELL_TYPE_FINISH
                    && (key == Crafty.keys['SPACE']
                        || key == Crafty.keys['ENTER']))
                {
                    return true;
                }
                return false;
            }
        });

        Crafty.c("Board", {
            CELL_TYPE: [CELL_TYPE_LETTER, CELL_TYPE_SOLID],
            LETTERS: ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"],
            //LETTERS: ["A"],
            init: function() {
                this.addComponent("2D, Canvas");
                this.x = BOARD_LEFT;
                this.y = BOARD_TOP;
                this.w = BOARD_WIDTH;
                this.h = BOARD_HEIGHT;
                this._setupBoard(0, 0, BOARD_ROWS, BOARD_COLS, CELL_WIDTH, CELL_HEIGHT);
            },
            _setupBoard: function(x, y, rows, cols, cw, ch) {
                this._board = [];
                for (var i=0; i<cols; i++) {
                    this._board[i] = [];
                    for (var j=0; j<rows; j++) {
                        var cell = Crafty.e("Cell")._makeCell(x + i*cw,
                                                             y + j*ch,
                                                             Crafty.math.randomElementOfArray(this.CELL_TYPE),
                                                             Crafty.math.randomElementOfArray(this.LETTERS));
                        this._board[i][j] = cell;
                    }
                }
            },
            _getRandomCell: function(type) {
                var cols = this._board.length;
                var rows = this._board[0].length;
                var cell, first = false;
                if(type == undefined) {first = true;}

                do {
                    var i = Crafty.math.randomInt(0, cols-1);
                    var j = Crafty.math.randomInt(0, rows-1);
                    cell = this._board[i][j];
                } while (!first && cell._type != type);
                return cell;
            },
            _getCell: function(x, y) {
                var cols = this._board.length;
                var rows = this._board[0].length;

                for (var i=0; i<cols; i++) {
                    for (var j=0; j<rows; j++) {
                        if(this._board[i][j]._isInsideCell(x,y)) {
                            return this._board[i][j];
                        }
                    }
                }
            },
            _getCellOnTop: function(x, y) {
                return this._getCell(x, y-CELL_HEIGHT);
            },
            _getCellOnBottom: function(x, y) {
                return this._getCell(x, y+CELL_HEIGHT);
            },
            _getCellOnLeft: function(x, y) {
                return this._getCell(x-CELL_WIDTH, y);
            },
            _getCellOnRight: function(x, y) {
                return this._getCell(x+CELL_WIDTH, y);
            }
        });
    }
    window.onload = (function() {
        initCrafty();
        var game = Crafty.e("Game");

        var board = Crafty.e("Board");
        game._setBoard(board);

        var finishPosition = board._getRandomCell();
        finishPosition._makeCell(finishPosition.x, finishPosition.y, CELL_TYPE_FINISH, " ");
        var startPosition = board._getRandomCell(CELL_TYPE_LETTER);

        var pl = Crafty.e("Player")._setBoard(board)._setStartPosition(startPosition.x, startPosition.y)._setUpdateCallback(game._playerUpdate);
    });
  </script>
</body>
</html>
